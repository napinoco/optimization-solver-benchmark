{% extends "base.html" %}

{% block title %}Solver Comparison - Optimization Solver Benchmark{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') if url_for else '#' }}">Dashboard</a></li>
        <li class="breadcrumb-item active">Solver Comparison</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-balance-scale me-2"></i>Solver Comparison
        </h2>
        <p class="text-muted">Compare performance characteristics across different optimization solvers.</p>
    </div>
</div>

<!-- Performance Comparison Charts -->
{% if solver_stats %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>Average Solve Time
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="timeComparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-check-circle me-2"></i>Success Rate
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 300px;">
                    <canvas id="successRateChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Performance Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>Detailed Performance Metrics
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Solver</th>
                                <th>Total Runs</th>
                                <th>Success Rate</th>
                                <th>Avg Time</th>
                                <th>Min Time</th>
                                <th>Max Time</th>
                                <th>Std Dev</th>
                                <th>Problems Solved</th>
                                <th>Reliability Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for solver_name, stats in solver_stats.items() %}
                            <tr>
                                <td>
                                    <strong class="text-primary">{{ solver_name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ solver_info[solver_name].environment if solver_info and solver_name in solver_info else 'Python' }}</small>
                                </td>
                                <td>{{ stats.total_runs }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="{% if stats.success_rate >= 0.9 %}text-success{% elif stats.success_rate >= 0.7 %}text-warning{% else %}text-danger{% endif %} fw-bold">
                                            {{ "%.1f%%" | format(stats.success_rate * 100) }}
                                        </span>
                                        <div class="progress ms-2" style="width: 60px; height: 8px;">
                                            <div class="progress-bar {% if stats.success_rate >= 0.9 %}bg-success{% elif stats.success_rate >= 0.7 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 style="width: {{ stats.success_rate * 100 }}%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-bold">{{ "%.3fs" | format(stats.avg_time) }}</span>
                                    {% if loop.index0 == 0 or stats.avg_time == solver_stats.values() | map(attribute='avg_time') | min %}
                                        <span class="badge bg-success ms-1">Fastest</span>
                                    {% endif %}
                                </td>
                                <td>{{ "%.3fs" | format(stats.min_time) }}</td>
                                <td>{{ "%.3fs" | format(stats.max_time) }}</td>
                                <td>{{ "%.3fs" | format(stats.get('std_dev', 0)) }}</td>
                                <td>{{ stats.unique_problems_solved }}</td>
                                <td>
                                    {% set reliability = (stats.success_rate * 0.7 + (1 - stats.avg_time / (solver_stats.values() | map(attribute='avg_time') | max)) * 0.3) %}
                                    <span class="{% if reliability >= 0.9 %}text-success{% elif reliability >= 0.7 %}text-warning{% else %}text-danger{% endif %} fw-bold">
                                        {{ "%.1f" | format(reliability * 100) }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Reliability Score:</strong> Weighted combination of success rate (70%) and relative speed (30%).
                        Higher scores indicate better overall performance.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Problem-wise Performance -->
{% if problem_stats %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-puzzle-piece me-2"></i>Performance by Problem Type
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="problemPerformanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Head-to-Head Comparison -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-vs me-2"></i>Head-to-Head Comparison
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for solver1 in solver_stats.keys() %}
                    {% for solver2 in solver_stats.keys() %}
                    {% if loop.index0 > loop.index0 %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card border-light">
                            <div class="card-body text-center">
                                <h6 class="card-title">{{ solver1 }} vs {{ solver2 }}</h6>
                                {% set stats1 = solver_stats[solver1] %}
                                {% set stats2 = solver_stats[solver2] %}
                                
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-primary">{{ solver1 }}</div>
                                        <div class="fw-bold">{{ "%.3fs" | format(stats1.avg_time) }}</div>
                                        <div class="small text-muted">{{ "%.1f%%" | format(stats1.success_rate * 100) }}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-info">{{ solver2 }}</div>
                                        <div class="fw-bold">{{ "%.3fs" | format(stats2.avg_time) }}</div>
                                        <div class="small text-muted">{{ "%.1f%%" | format(stats2.success_rate * 100) }}</div>
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    {% if stats1.avg_time < stats2.avg_time %}
                                        <span class="badge bg-primary">{{ solver1 }} Faster</span>
                                    {% elif stats2.avg_time < stats1.avg_time %}
                                        <span class="badge bg-info">{{ solver2 }} Faster</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Tied</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- No Data Message -->
{% if not solver_stats %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-balance-scale fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Solver Data Available</h4>
                <p class="text-muted">Run benchmarks with multiple solvers to see detailed comparisons.</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if solver_stats %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const solverNames = {{ solver_stats.keys() | list | tojson }};
    const avgTimes = [
        {% for name in solver_stats.keys() %}
        {{ solver_stats[name].avg_time }}{{ ',' if not loop.last }}
        {% endfor %}
    ];
    const successRates = [
        {% for name in solver_stats.keys() %}
        {{ solver_stats[name].success_rate * 100 }}{{ ',' if not loop.last }}
        {% endfor %}
    ];
    
    // Colors for different solvers
    const colors = [
        'rgba(255, 99, 132, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)'
    ];
    
    // Time Comparison Chart
    const timeCtx = document.getElementById('timeComparisonChart').getContext('2d');
    new Chart(timeCtx, {
        type: 'bar',
        data: {
            labels: solverNames,
            datasets: [{
                label: 'Average Solve Time (seconds)',
                data: avgTimes,
                backgroundColor: colors.slice(0, solverNames.length),
                borderColor: colors.slice(0, solverNames.length).map(c => c.replace('0.8', '1')),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Average Solve Time Comparison'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Time (seconds)'
                    }
                }
            }
        }
    });
    
    // Success Rate Chart
    const successCtx = document.getElementById('successRateChart').getContext('2d');
    new Chart(successCtx, {
        type: 'doughnut',
        data: {
            labels: solverNames,
            datasets: [{
                data: successRates,
                backgroundColor: colors.slice(0, solverNames.length),
                borderColor: colors.slice(0, solverNames.length).map(c => c.replace('0.8', '1')),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Success Rate Distribution'
                }
            }
        }
    });
    
    {% if problem_stats %}
    // Problem Performance Chart
    const problemCtx = document.getElementById('problemPerformanceChart').getContext('2d');
    const problemNames = {{ problem_stats.keys() | list | tojson }};
    
    const datasets = solverNames.map((solverName, index) => ({
        label: solverName,
        data: problemNames.map(problemName => {
            const problemData = {{ problem_stats | tojson }};
            const solverResults = problemData[problemName].solver_results;
            return solverResults[solverName] ? solverResults[solverName].solve_time : null;
        }),
        backgroundColor: colors[index],
        borderColor: colors[index].replace('0.8', '1'),
        borderWidth: 2
    }));
    
    new Chart(problemCtx, {
        type: 'bar',
        data: {
            labels: problemNames,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                },
                title: {
                    display: true,
                    text: 'Solve Time by Problem and Solver'
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Problems'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Time (seconds)'
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endif %}
{% endblock %}